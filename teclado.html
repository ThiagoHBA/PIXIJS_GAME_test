<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teclado</title>
</head>
<body>
    <script src="js/pixi.min.js"></script>
    <script>

    let actualY;
    let jump = false;

    let app = new PIXI.Application({ 
        width: window.screen.width, 
        height: window.screen.height,     
        antialiasing: true, 
        transparent: false, 
        backgroundColor: 0xAAAAAA,
        resolution: 1,
    }
    );

    document.body.appendChild(app.view);
   
    const texture = PIXI.Texture.from('images/player.png');
    
    texture.baseTexture.scaleMode = PIXI.SCALE_MODES.NEAREST;
    
    let state;
    let player = new PIXI.Sprite(texture);
 
    player.y = 250; 
    player.x = 250;
    player.vx = 0;
    player.vy = 0;

    app.stage.addChild(player);

    let left = keyboard(37),
        up = keyboard(32),
        right = keyboard(39),
        down = keyboard(40);

    left.press = function() {
        player.vx = -5;
        player.vy = 0;
    };

    left.release = function() {
        if (!right.isDown && player.vy === 0) {
        player.vx = 0;
        }
    };

    const target = new PIXI.Point();

    up.press = function() {
        if(jump) return;
        jump = true;
        
        actualY = player.y;
        target.y = player.y - 100;

        app.ticker.add(() => {
            player.y += (target.y - player.y) * 0.1;
        
            if(Math.floor(player.y) == Math.floor(target.y)){
                target.y = Math.floor(actualY);
            }

            if(Math.ceil(player.y) == Math.floor(actualY)){
                jump = false;
                return;
            }
        });
        
    };

    up.release = function() {
        if (!down.isDown && player.vx === 0) {
        player.vy = 0;
        }
    };

    right.press = function() {
        player.vx = 5;
        player.vy = 0;
    };
    right.release = function() {
        if (!left.isDown && player.vy === 0) {
        player.vx = 0;
        }
    };

    state = play;

    app.ticker.add(delta => gameLoop(delta));

    function gameLoop(delta){

    state(delta);
    }

    function play(delta) {
    player.x += player.vx;
    player.y += player.vy
    }

    function keyboard(keyCode) {
    var key = {};
    key.code = keyCode;
    key.isDown = false;
    key.isUp = true;
    key.press = undefined;
    key.release = undefined;

    key.downHandler = function(event) {
        if (event.keyCode === key.code) {
        if (key.isUp && key.press) key.press();
        key.isDown = true;
        key.isUp = false;
        }
        event.preventDefault();
    };

    key.upHandler = function(event) {
        if (event.keyCode === key.code) {
        if (key.isDown && key.release) key.release();
        key.isDown = false;
        key.isUp = true;
        }
        event.preventDefault();
    };

    window.addEventListener(
        "keydown", key.downHandler.bind(key), false
    );
    window.addEventListener(
        "keyup", key.upHandler.bind(key), false
    );
    return key;
    }

    </script>
    
</body>
</html>